/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
/**
 * Author:  HP
 * Created: Dec 17, 2016
 */

CREATE OR REPLACE TRIGGER POST_VOTE_POINT_INSERT
AFTER INSERT
ON POST_VOTES
FOR EACH ROW
DECLARE
	AID NUMBER;
BEGIN
	SELECT USER_ID INTO AID FROM POSTS WHERE POST_ID = :NEW.POST_ID;
	UPDATE USERS SET POINT = POINT + :NEW.VOTE * 5 WHERE USER_ID = AID;
END;
/


CREATE OR REPLACE TRIGGER POST_VOTE_POINT_UPDATE
AFTER UPDATE
ON POST_VOTES
FOR EACH ROW
DECLARE
	AID NUMBER;
BEGIN
	IF :OLD.VOTE <> :NEW.VOTE THEN
		SELECT USER_ID INTO AID FROM POSTS WHERE POST_ID = :NEW.POST_ID;
		UPDATE USERS SET POINT = POINT + :NEW.VOTE * 10 WHERE USER_ID = AID;
	END IF;
END;
/


CREATE OR REPLACE TRIGGER COMMENT_VOTE_POINT_INSERT
AFTER INSERT
ON COMMENT_VOTES
FOR EACH ROW
DECLARE
	AID NUMBER;
BEGIN
	SELECT USER_ID INTO AID FROM COMMENTS WHERE COMMENT_ID = :NEW.COMMENT_ID;
	UPDATE USERS SET POINT = POINT + :NEW.VOTE WHERE USER_ID = AID;
END;
/


CREATE OR REPLACE TRIGGER COMMENT_VOTE_POINT_UPDATE
AFTER UPDATE
ON COMMENT_VOTES
FOR EACH ROW
DECLARE
	AID NUMBER;
BEGIN
	IF :OLD.VOTE <> :NEW.VOTE THEN
		SELECT USER_ID INTO AID FROM COMMENTS WHERE COMMENT_ID = :NEW.COMMENT_ID;
		UPDATE USERS SET POINT = POINT + :NEW.VOTE * 2 WHERE USER_ID = AID;
	END IF;
END;
/